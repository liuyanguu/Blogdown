---
title: '2024 National K-12: Does a Higher Rating Lead to a Higher Standing?'
author: Yang Liu
date: '2024-12-15'
slug: 2024-national-k-12-does-a-higher-rating-lead-to-a-higher-standing
categories:
  - Blog
tags: []
---

<div style="text-align: center;">
**Statistics of 2024 National K-12 Grades Championship**    
https://www.uschess.org/results/2024/k12/
</div>


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE,
                      error = FALSE, fig.width = 12, fig.height = 6)
# error=TRUE allows error
```

```{r}
library("data.table")
library("ggplot2")
library("ggforce")
library("cowplot")
library("ggh4x")
library("readxl")

# Path to your Excel file
excel_file <- here::here("../Data/2024 Final standing.xlsx")

# Get the names of all sheets in the Excel file
sheet_names <- excel_sheets(excel_file)

# Read all sheets and combine them into one data.table
combined_data <- rbindlist(
  lapply(sheet_names, function(sheet) {
    # Read the current sheet as a data.table
    sheet_data <- as.data.table(read_excel(excel_file, sheet = sheet))
    # Add a column for the sheet name
    sheet_data[, sheet_name := sheet]
    return(sheet_data)
  }),
  use.names = TRUE, fill = TRUE
)

combined_data[, Grade:= gsub("Grade", "", sheet_name)]
combined_data[, Grade:= factor(as.factor(Grade), levels = c("K", as.character(1:12)))]

combined_data[, Grade_full := factor(as.factor(sheet_name), levels = sheet_names)]

mytheme1 <- theme_minimal() + 
    theme(panel.grid = element_blank(),
          axis.line.x = element_line(color = "black"),
              axis.title.x = element_text(size = 14), # Enlarges x-axis label
    axis.title.y = element_text(size = 14), # Enlarges y-axis label
    axis.text = element_text(size = 12), # Enlarges axis text
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold") # Enlarged title size
    )


#0. map of participants by state -------------------------------------------------------
source(here::here("Code/COVID_make_map.R"))
dt_US <- combined_data[, .(N = .N), by = St]
US_map_participant <- make_heatmap(data = dt_US, 
            geo_data = get_state_name(),
            state_var = "St", fill_var = "N", label_var = "abb", 
            fill_var_label = "Number of participants")

#1. bar of participants by grade ------------------------------------------------------
g_bar <-
  # Create a bar chart from combined_data
  ggplot(combined_data, aes(x = Grade)) +
    geom_bar(width = 0.7) +
    geom_text(stat = "count", aes(label = ..count..), vjust = -0.5, size = 4) +
    labs(title = "Number of Participants by Grade", x = "Grade", y = "Count") +
    scale_y_continuous(expand = c(0, 0), limits = c(0, 400)) +
    mytheme1


# Add a new column for Rate category based on the given ranges
combined_data[, RateCategory := cut(
  Rate,
  breaks = c(0, 500, 1000, 1500, 2000, Inf),
  labels = c("0-500", "500-1000", "1000-1500", "1500-2000", ">2000"),
  right = FALSE
)]

custom_colors <- c(
  "0-500" = "#FFC20E",
  "500-1000" = "#80BD41",
  "1000-1500" = "#00833D",
  "1500-2000" = "#1CABE2",
  ">2000" = "#0058AB"
)

dt_mean <- combined_data[, .(MeanRate = mean(Rate, na.rm = TRUE)), by = Grade]
dt_mean[, label:= round(MeanRate, 0)]
# calculate the difference between each grade, e.g. 1 - K, 2 - 1
dt_mean[, diff:= c(NA, diff(MeanRate))]

g_rating <- ggplot(combined_data, aes(x = Grade, y = Rate, color = RateCategory)) +
  geom_sina(aes(group = Grade), alpha = 0.7, size = 2, maxwidth = 1) + # Add sina plot with transparency and point size
  geom_boxplot(aes(group = Grade), outlier.shape = NA, width = 0.3, alpha = 0.5) + # Boxplot by Grade
  geom_point(data = dt_mean, aes(x = Grade, y = MeanRate), 
             size = 9, alpha = 1, colour = "red", shape = 95) +
  geom_text(data = dt_mean, aes(x = Grade, y = MeanRate, label = label),
            colour = "red", vjust = -0.5, inherit.aes = FALSE) + # Add mean rating as text
  labs(title = "Distribution of Rating by Grade", 
       x = "Grade", y = "Rating", color = "Rating" ) +
  scale_color_manual(values = custom_colors) + # Use custom colors
  mytheme1


#3. Percentile vs Rating ------------------------------------------------------

# Function to calculate percentiles within each Grade
calculate_percentile <- function(data, value_col, group_col) {
  data[, Percentile := 100 * frank(get(value_col), ties.method = "average") / .N, by = group_col]
  return(data)
}

# Step 1: Calculate percentile of "No." by "Grade"
combined_data <- as.data.table(combined_data) # Convert to data.table
combined_data <- calculate_percentile(combined_data, value_col = "No.", group_col = "Grade")

model <- lm(Percentile ~ Rate, data = combined_data)
r2 <- summary(model)$r.squared

# Step 2: Create the scatter plot with marginal histograms
p_scatter <- ggplot(combined_data, aes(x = Rate, y = Percentile)) +
  geom_point(aes(color = Grade), size = 2, alpha = 0.5) + # Scatter plot
    geom_smooth(method = "lm", se = FALSE, color = "#333333", linewidth = 0.8, alpha = 0.6) + # Smooth regression line
    geom_smooth(method = "loess",  se = FALSE, color = "#F26A21", linewidth = 1, alpha = 0.8) + # Smooth regression line
  
  scale_y_reverse() +                 # Reverse the y-axis
  labs(title = "Percentile vs. Rating", x = "Rate", y = "Percentile", color = "Grade" ) +
  mytheme1 + theme(legend.position = "none") + 
  ggpubr::stat_cor(method = "pearson")

# scatterplot by grade
p_scatter_group <- p_scatter + 
  ggh4x::facet_wrap2(~ Grade_full, ncol = 2, axes = "all", scales = "free_y")
# ggsave("temp/scatter_facet.png", p_scatter_group, width = 12, height = 24, bg = "white")

# Step 3: Add marginal histograms
p_scatter_all <- ggExtra::ggMarginal(p_scatter, type = "histogram", bins = 50, size = 10, color = "white", fill = "grey")


#4. Pts vs rating  ------------------------------------------------------
unique_pts <- sort(unique(combined_data$Pts))
dt_mean_pts <- combined_data[, .(MeanRate = mean(Rate, na.rm = TRUE)), by = Pts]

dt_mean_pts[, label:= round(MeanRate, 0)]
g_points_rating0 <- ggplot(combined_data, aes(x = Pts , y = Rate, color = Grade)) +
  geom_sina(aes(group = Pts), alpha = 0.7, size = 2, maxwidth = 1) + # Add sina plot with transparency and point size
  geom_boxplot(aes(group = Pts), outlier.shape = NA, width = 0.3, alpha = 0.5) + # Boxplot by Grade
  # geom_point(data = dt_mean, aes(x = Grade, y = MeanRate), 
  #            size = 9, alpha = 1, colour = "red", shape = 95) +
  labs( y = "Rating", x = "Points achieved", color = "Grade" ) + 
    scale_x_continuous(breaks = unique_pts) +  # Set x-axis ticks to unique Pts values
  geom_point(data = dt_mean_pts, aes(x = Pts, y = MeanRate), 
             size = 9, alpha = 1, colour = "red", shape = 95) +
  geom_text(data = dt_mean_pts, aes(x = Pts, y = MeanRate, label = label),
            colour = "red", vjust = -0.5, inherit.aes = FALSE) + # Add mean rating as text
  mytheme1


g_points_rating <- ggExtra::ggMarginal(g_points_rating0, type = "histogram", bins = 30, size = 10, color = "white", fill = "grey")

g_points_rating_group <- ggplot(combined_data, aes(x = Pts , y = Rate, color = Grade)) +
  geom_sina(aes(group = Pts), alpha = 0.7, size = 2, maxwidth = 1) + # Add sina plot with transparency and point size
  geom_boxplot(aes(group = Pts), outlier.shape = NA, width = 0.3, alpha = 0.5) + # Boxplot by Grade
  labs( y = "Rating", x = "Points achieved", color = "Grade" ) + 
    scale_x_continuous(breaks = unique_pts) +  # Set x-axis ticks to unique Pts values
  mytheme1 + theme(axis.text = element_text(size = 8)) +
  ggh4x::facet_wrap2(~ Grade_full, ncol = 2, axes = "all", scales = "free_y")

# ggsave("temp/g_points_rating_group.png", g_points_rating_group, width = 12, height = 24, bg = "white")

```

# Over 2,500 contestants from 43 states participated in the 2024 National K-12 Grades Championship

```{r, fig.width = 6, fig.height = 4}
US_map_participant
```


The 2024 National K-12 Grades Championship attracted a total of `r formatC(combined_data[,.N], format = "d", big.mark = ",")` participants from `r combined_data[, uniqueN(St)]` states. There are over 1,000 participants from New York, followed by Virginia (250 participants) and New Jersey (218 participants). 


## Fourth grade (age 9) is the most competitive, with nearly 350 participants.

Grades 3, 4, and 5 have the highest number of participants, while Grade K has the fewest.

```{r, fig.width = 6, fig.height = 4}
g_bar
# ggsave("temp/barplot.png", g_bar, width = 6, height = 4, bg = "white")
```

## 11th Grade boasts the highest average rating of 1,600.

The mean is indicated by the red bar in the plot below, while the black bars in the boxplot represent the median.  

```{r, fig.width = 10, fig.height = 6}
g_rating
# ggsave("temp/rating.png", g_rating, width = 10, height = 6, bg = "white")
```

## Does a higher rating guarantee a higher standing?  

Not necessarily! To standardize standings across grades, I calculated the percentile within each grade, scaling it from 0 to 100. The plot below illustrates the relationship between rating and percentile, with colors representing different grades.

Interestingly, the correlation between rating and percentile is relatively weak. While it is statistically significant due to the large sample size, the R-squared value (from a fitted linear regression) is only `r round(r2, 2)`. This suggests that the correlation isnâ€™t as strong as one might assume. The red lines represent a loess (locally estimated scatterplot smoothing) curve, which highlights the trend but shows limitations, particularly when examined by individual grades.

```{r, fig.width = 8, fig.height = 6}
p_scatter_all
# ggsave("temp/scatter.png", p_scatter_all, width = 8, height = 6, bg = "white")
```

## Percentile vs. Rating by Grade!

```{r, fig.width = 12, fig.height = 24}
p_scatter_group

```

## Points Achieved vs. Rating  

Points achieved determined the final standings. This provides another perspective on the variation in ratings among participants who achieved the same number of points.

**The histogram at the top also shows that most kids achieved 3 or 4 points.**

```{r, fig.width = 10, fig.height = 6}
g_points_rating
# ggsave("temp/g_points_rating.png", g_points_rating, width = 10, height = 6, bg = "white")
```

## Points Achieved vs. Rating by Grade!

```{r, fig.width = 12, fig.height = 24}
g_points_rating_group


```
